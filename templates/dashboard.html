<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
</head>
<body>
    <h1>Welcome, {{ user_email }}</h1>

    <h2>Linked Accounts</h2>
    <ul>
        <li>
            Slack:
            {% if slack_connected %}
                Connected as {{ slack_user_id }} (connected at {{ slack_connected_at }})
                <a href="/slack/disconnect">Disconnect</a>
            {% else %}
                Not connected
                <a href="/slack/login">Connect Slack</a>
            {% endif %}
        </li>
        <li>
            Spotify:
            {% if spotify_connected %}
                Connected (connected at {{ spotify_connected_at }})
                <a href="/spotify/disconnect">Disconnect</a>
            {% else %}
                Not connected
                <a href="/spotify/login">Connect Spotify</a>
            {% endif %}
        </li>
    </ul>

    <h2>Spotify Pull Management</h2>
    <form method="post" action="http://127.0.0.1:1605/spotify/pull/start/{{ firebase_uid }}">
        <button type="submit">Start Spotify Pull</button>
    </form>
    <form method="post" action="http://127.0.0.1:1605/spotify/pull/stop/{{ firebase_uid }}">
        <button type="submit">Stop Spotify Pull</button>
    </form>
    <p>Spotify Pull Status: <span id="spotifyPullStatus">Loading...</span></p>

    <h2>Slack Worker Management</h2>
    <form method="post" action="http://127.0.0.1:1605/slack/worker/start/{{ firebase_uid }}">
        <button type="submit">Start Slack Worker</button>
    </form>
    <form method="post" action="http://127.0.0.1:1605/slack/worker/stop/{{ firebase_uid }}">
        <button type="submit">Stop Slack Worker</button>
    </form>
    <p>Slack Worker Status: <span id="slackWorkerStatus">Loading...</span></p>

    <h2>Set Global Status</h2>
    <form id="globalStatusForm">
        <label>Status Text: <input type="text" id="globalStatusText"></label><br>
        <label>Status Emoji: <input type="text" id="globalStatusEmoji"></label><br>
        <button type="submit">Set Global Status</button>
    </form>

    <script>
    document.getElementById('globalStatusForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const text = document.getElementById('globalStatusText').value;
        const emoji = document.getElementById('globalStatusEmoji').value;
        const firebaseUid = '{{ firebase_uid }}';

        fetch(`http://127.0.0.1:1605/global/status/${firebaseUid}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text, emoji })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.success ? 'Global status updated successfully' : 'Error: ' + (data.error || 'Unknown Error'));
        })
        .catch(error => {
            alert('Fetch-Error: ' + error);
        });
    });

    function updateStatuses() {
        const firebaseUid = '{{ firebase_uid }}';

        fetch(`http://127.0.0.1:1605/spotify/pull/status/${firebaseUid}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('spotifyPullStatus').innerText = data.pulling ? 'Active' : 'Inactive';
            });

        fetch(`http://127.0.0.1:1605/slack/worker/status/${firebaseUid}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('slackWorkerStatus').innerText = data.active ? 'Active' : 'Inactive';
            });
    }

    setInterval(updateStatuses, 5000);
    updateStatuses();
    </script>

    <h2>Debug</h2>
    <a href="http://127.0.0.1:1605/user/tokens/{{ firebase_uid }}">View Stored Tokens</a><br>
    <a href="http://127.0.0.1:1605/spotify/now/{{ firebase_uid }}">Now Playing</a><br>

    <h2>System</h2>
    <a href="http://127.0.0.1:1605/health">Server Health</a>

    <h2>Logout</h2>
    <a href="/logout">Logout</a>
</body>
</html>
